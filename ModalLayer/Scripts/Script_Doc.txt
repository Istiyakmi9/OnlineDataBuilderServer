DELIMITER $$

drop procedure if exists sp_new_registration $$

CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_new_registration`(

/*
	set @value = '';
	Call sp_new_registration('BOTTOMHALF PVT.LTD', 'BOTTOMHALF', '9000000000','istiyaq.mi9@gmail.com', 'ADMIN', 'USER', "EiOcNOYYuHiQrEc0z16rEjUlp71vYq73fNDXL1PbZZ4=", @value);
    select @value;

*/
	_OrganizationName varchar(250),
	_CompanyName varchar(250),
	_Mobile varchar(20),
	_EmailId varchar(100),
    _FirstName varchar(100),
    _LastName varchar(100),
	_Password varchar(250),
    out _ProcessingResult varchar(50)
)
Begin
    Begin
		Declare Exit handler for sqlexception
		Begin
			Get Diagnostics condition 1 @sqlstate = RETURNED_SQLSTATE,
			@errorno = MYSQL_ERRNO,
			@errortext = MESSAGE_TEXT;
            
            RollBack;
			Set @Message = concat ('ERROR ', @errorno ,  ' (', @sqlstate, '); ', @errortext);
			Call sp_LogException (@Message, '', 'sp_new_registration', 1, 0, @Result);
		end;  
        
        Start Transaction;
        begin

			# Sample email template detai
            Insert into email_templates values(default, 'Billing Template', 'Developer(s) bill detail', 
			'Dear Sir/Madam', 'Thanks & Regards,', 
			'{"FirstPhase":["GENERATED STAFFING BILL FOR THE LAST MONTH","BILLING DETAIL AS FOLLOWS:"],"Body":[],"EndPhase":["PLEASE FIND ATTACHED PDF BILL"]}', 
			'Please check detail if required any changes do revert to us.', 'Team BottomHalf.',
			_Mobile, null, 1, utc_date());

			# Inserting initial bill information.
           
			insert into billtype values(1, 'Bill number sequence for generating payment to clients');
			insert into bills values(1, 1, 0, 8, 1);
            
            #insert user type deatils

			INSERT INTO `usertypedetail` VALUES 
            (1,'Admin','Administrator will complete access granted.'),
            (2,'Employee','Employee level access.'),
            (3,'Candidate','Candidate level access.'),
            (4,'Client','Candidate level access.'),
            (5,'Other','Other level access.'),
            (6,'Company','Company related access similar to Admin. This type will be used only for file saving purpose.');
			if not exists(select 1 from organization_detail where OrganizationName = _OrganizationName) then
            
             # inserting roles and menu

            INSERT INTO `rolesandmenu` VALUES 
            ('Administration',NULL,NULL,NULL,NULL,NULL,1),
            ('Dashboard','Administration','dashboard','fa fa-tachometer',NULL,NULL,2),
            ('Employees','Administration','employees','fa fa-id-card',NULL,NULL,4),
            ('Client','Administration','clients','fa fa-building-o',NULL,NULL,5),
            ('Bills','Administration','billdetail','fa fa-file-o',NULL,NULL,7),
            ('Home',NULL,NULL,NULL,NULL,NULL,8),
            ('Profile','Manage','profile','fa fa-user',NULL,NULL,9),
            ('Roles','Settings','roles','fa fa-object-group',NULL,NULL,10),
            ('Generate Bill','Administration','generatebill','fa fa-file-pdf-o',NULL,NULL,11),
            ('Attendence','Manage','attendance','fa fa-id-badge',NULL,NULL,12),
            ('Manage',NULL,NULL,NULL,NULL,NULL,13),
            ('Declaration','Accounts','declaration','fa fa-handshake-o',NULL,NULL,14),
            ('Salary','Accounts','salary','fa fa-money',NULL,NULL,15),
            ('Summary','Accounts','summary','fa fa-history',NULL,NULL,16),
            ('Preferences','Accounts','preferences','fa fa-object-group',NULL,NULL,17),
            ('Dashboard','Home','dashboard','fa fa-tachometer',NULL,NULL,18),
            ('Accounts',NULL,NULL,NULL,NULL,NULL,19),
            ('Timesheet','Manage','timesheet','fa fa-calendar',NULL,NULL,20),
            ('Holidays','Manage','planholidays','fa fa-calendar-minus-o',NULL,NULL,21),
            ('About Me','Home','profile','fa fa-user',NULL,NULL,22),
            ('Tax','Accounts','taxcalculation','fa fa-money',NULL,NULL,23),
            ('Request','Team','request','fa fa-hand-o-right',NULL,NULL,24),
            ('Team',NULL,NULL,NULL,NULL,NULL,25),
            ('Notification','Team','notification','fa fa-bell-o',NULL,NULL,26),
            ('Settings',NULL,NULL,NULL,NULL,NULL,28),
            ('Leave Plan','Settings','leave','fa fa-calendar-check-o',NULL,NULL,29),
            ('Payroll','Settings','payrollsettings','fa fa-cog fa-spin fa-fw',NULL,NULL,30),
            ('Email Setting','Settings','emailsetting','fa fa-envelope',NULL,NULL,31),
            ('Menu','Settings','menu','fa fa-bars',NULL,NULL,32),
            ('Project','Team','project','fa fa-lightbulb-o',NULL,NULL,33),
            ('Company','Settings','companysettings','fa fa-cogs',NULL,NULL,34);           
            
            # Insert designation deatils

			Insert into designation_detail values
			(default, 'Admin', 'Full access at organization level', 0, null, null),
			(default, 'Project Manager', 'Project Manager', 0, null, null),
			(default, 'Solution Architect', 'Solution Architect', 0, null, null),
			(default, 'Application Architect', 'Application Architect', 0, null, null),
			(default, 'Team Lead', 'Team Lead', 0, null, null),
			(default, 'Full stact developer', 'Full stact developer', 0, null, null),
			(default, 'Senior Software engineer', 'Sr. Software engineer', 0, null, null),
			(default, 'Junior Software engineer', 'Junior Software engineer', 0, null, null),
			(default, 'Software Associate', 'Software Associate', 0, null, null),
			(default, 'Tester', 'Tester', 0, null, null),
			(default, 'HR Manager', 'HR Manager', 0, null, null),
			(default, 'System Engineer', 'System Engineer', 0, null, null);


			#Inserting accessibility description

			INSERT INTO `accessibility_description` VALUES 
            (1,'Complete access. (read, udpate and detele)'),
            (2,'Only read access.'),
            (3,'Read and update access.');

			# inserting access level
			INSERT INTO `accesslevel` VALUES 
            (1,'Admin','Having all rights','2021-08-17 22:25:53',NULL),
            (2,'User','View or edit only personal detail.','2021-08-17 22:26:35','2022-03-13 08:48:35'),
            (3,'Management','Can add or edit most of the detail.','2022-03-13 08:49:18',NULL);
            
			begin
				set @userTypeId = 0;
				set @accessLevelId = 1;
				select UserTypeId into @userTypeId from usertypedetail
				where RoleName = 'Admin';
				
				set @designationId = 0;
				select DesignationId into @designationId from designation_detail
				where DesignationName = 'Admin';
			
				set @organizationId = 0;
				select OrganizationId into @organizationId from organization_detail
                order by OrganizationId desc;
                set @organizationId = @organizationId + 1;                

                select * from organization_detail;
				Insert into organization_detail values(
					@organizationId,
					_OrganizationName,
					_Mobile,
					_EmailId,
					_Mobile,
					null,
					null,
					0,
                    null,
					utc_date(),
                    null
				);            
				
				set @companyId = 0;
				select CompanyId into @companyId from company
                order by CompanyId desc;
                set @companyId = @companyId + 1;   

				Insert into company values(            
					@companyId,
					@organizationId,
					_OrganizationName,
					_CompanyName,
					null,
					0,
					null,
					null,
					null,
					null,
					null,
					null,
					null,
					null,
					_Mobile,
					_EmailId,
					null,
					null,
					null,
					null,
					_Mobile,
					null,
					null,
					0,
					0,
					null,
					null,
					null,
					null,
					null,
                    null,
                    null,
					true,
					null,
					0,
					null,
					utc_date(),
					null
				);
				
				set @employeeId = 0;
				select EmployeeUid into @employeeId from employees
                order by EmployeeUid desc;
                set @employeeId = @employeeId + 1;

				Insert into employees values(
					@employeeId,
					_FirstName,
					_LastName,
					_Mobile,
					_EmailId,
					true,
					0,
					null,
					utc_date(),
					null,
					0,
					@designationId,
					@userTypeId,
					0,
					0,
                    0,
					@companyId,
					0
				);

                Insert into employeeprofessiondetail values (
					default,
                    @employeeId,
                    _FirstName,
					_LastName,
					_Mobile,
                    null,
					_EmailId,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    0,
                    null,
                    utc_date(),
                    null,
                    null
                );

                Insert into employeepersonaldetail values (
					default,
					@employeeId,
                    _Mobile,
                    null,
                    _EmailId,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    true,
                    null,
                    null,
                    null,
                    0,
                    null,
                    utc_date(),
                    null,
                    null
                );

				Insert into employeelogin values(
					default,
					@employeeId,
					@userTypeId,
					@accessLevelId,
					_Password,
					_EmailId,
					_Mobile,
					@organizationId,
					@companyId,
					0,
					null,
					utc_date(),
					null
				);
                
				insert into bank_accounts values (
					default,
                    @organizationId,
                    @companyId,
					null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    null,
                    true,
                    0,
                    null,
                    utc_date(),
                    null
                );
				set _ProcessingResult = 'updated';
			end;
			end if;
        end;
        Commit;
	End;
End$$
DELIMITER ;


